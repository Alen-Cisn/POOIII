@using Txt.Shared.Dtos
@using Txt.Ui.Services.Interfaces
@using Txt.Ui.Shared
@inject ISnackbar Snackbar
@inject INotesService NotesService
@inject ILogger<NavMenu> Logger

<MudDrawer @bind-Open="Open" @bind-Clipmode="mode">
    <MudStack Spacing="0" Justify="Justify.SpaceBetween">
        <MudTreeView T="FolderOrNote" Items="@treeItems" Dense="true">
            <ItemTemplate>
                <MudTreeViewItem Text="@context.Value?.Name" Items="@context?.Children">
                    <BodyContent Context="item">
                        <MudIcon Icon="@context.Icon" Size="Size.Small" />
                        <MudText Typo="Typo.body2" Class="text-truncate"
                            Style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                            @context?.Value?.Name
                        </MudText>
                        <ActionMenu FolderOrNote="@context?.Value" OnFolderOrNoteChange="GetFolderTree" />
                    </BodyContent>
                </MudTreeViewItem>
            </ItemTemplate>
        </MudTreeView>
    </MudStack>
</MudDrawer>

@code {
    [Parameter]
    public bool Open { get; set; } = true;
    [Parameter]
    public EventCallback<bool> OpenChanged { get; set; }
    private DrawerClipMode mode { get; set; } = DrawerClipMode.Always;
    private HashSet<TreeItemData<FolderOrNote>> treeItems = new HashSet<TreeItemData<FolderOrNote>>();

    protected override async Task OnInitializedAsync()
    {
        await GetFolderTree();

    }

    private async Task GetFolderTree()
    {
        var rootFolder = await NotesService.GetRootFolderAsync();
        if (rootFolder == null)
        {
            Snackbar.Add("There was an error retrieving the root folder.", Severity.Error);
            return;
        }
        treeItems = BuildTree(rootFolder);
        StateHasChanged();
    }

    private HashSet<TreeItemData<FolderOrNote>> BuildTree(FolderDto rootFolder)
    {
        if (rootFolder.ChildrenFolders != null && rootFolder.ChildrenFolders.Count() > 0)
        {

            return BuildTreeItems(rootFolder.ChildrenFolders);
        }
        else
        {
            return new();
        }
    }

    private HashSet<TreeItemData<FolderOrNote>> BuildTreeItems(IEnumerable<FolderDto> folders)
    {
        var treeItems = new HashSet<TreeItemData<FolderOrNote>>();

        foreach (var folder in folders)
        {
            HashSet<TreeItemData<FolderOrNote>> childrenItems = new HashSet<TreeItemData<FolderOrNote>>();

            if (folder.ChildrenFolders != null && folder.ChildrenFolders.Any())
            {
                childrenItems.UnionWith(BuildTreeItems(folder.ChildrenFolders));
            }

            if (folder.ChildrenNotes != null)
            {
                foreach (var note in folder.ChildrenNotes)
                {
                    childrenItems.Add(new TreeItemData<FolderOrNote>
                        {
                            Value = new FolderOrNote
                            {
                                Type = FolderOrNote.TypeEnum.Note,
                                Id = note.Id,
                                Name = note.Name
                            },
                            Icon = Icons.Material.Outlined.Note,
                            Children = null,
                            Expandable = false,
                            Text = note.Name // Use note name for display
                        });
                }
            }


            var treeItem = new TreeItemData<FolderOrNote>()
                {
                    Value = new FolderOrNote()
                    {
                        Type = FolderOrNote.TypeEnum.Folder,
                        Id = folder.Id,
                        Name = folder.Name
                    },
                    Icon = Icons.Material.Outlined.Folder,
                    Children = childrenItems.ToList(),
                    Expandable = childrenItems.Any(),
                    Text = folder.Name,
                    Expanded = true,
                    Visible = true
                };
            treeItems.Add(treeItem);
        }

        return treeItems;
    }

}
